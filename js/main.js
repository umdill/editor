// NOTE: ROTATING LAVA COPY DOES NOT WORK YET, IM FIXING IT LATER!!
function newId(){return Date.now()+nextId++}function cloneObject(e){let t=clone(e);return"teleporter"===t.type&&(t.id=newId()),t}function targetedObject(e){for(let t of types){let s=getObjects(t);for(let i=s.length-1;i>=0;i--){let n=s[i],[{x:a,y:r},{x:o,y:u}]=points("rotLavaPoint"===t?{pos:n,size:{x:0,y:0}}:n),p={x:e.pageX,y:e.pageY};if("text"===t){if(pointInCircle(p,{x:a,y:r},5*camScale+selectBuffer))return n;continue}if("turret"===t){if(pointInCircle(p,{x:a,y:r},3*camScale+selectBuffer))return n;continue}if("rotLavaPoint"===t){if(pointInCircle(p,{x:a,y:r},.5*camScale+selectBuffer))return n;continue}if(pointInRect(p,{x:a-selectBuffer,y:r-selectBuffer},{x:o+selectBuffer,y:u+selectBuffer}))return n}}return null}canvas.addEventListener("wheel",e=>{if(e.ctrlKey)return;let t=.85**(e.deltaY/125),s=(e.pageX-canvas.width/2)/camScale+camX,i=(e.pageY-canvas.height/2)/camScale+camY;camX=(t*s-s+camX)/t,camY=(t*i-i+camY)/t,camScale*=t}),canvas.addEventListener("mousedown",e=>{if(1===e.button&&e.preventDefault(),0!==e.button)return;let t=targetedObject(e),s=e=>{};if(t){selectedObject&&"element"in selectedObject&&hide(selectedObject.element),"rotLavaPoint"===t.type?show((selectedObject=t.rotLava).element):"turretRegion"===t.type?show((selectedObject=t.turret).element):show((selectedObject=t).element);let{x:i,y:n}=t.pos??t,{x:a,y:r}=t.size??{x:0,y:0},o=Math.round((e.pageX-canvas.width/2)/camScale+camX),u=Math.round((e.pageY-canvas.height/2)/camScale+camY);if("rotLavaPoint"===t.type){let p=t.rotLava;s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),a=Math.round((e.pageY-canvas.height/2)/camScale+camY);p.inputs.pX.value=t.x=Math.round(s-o+i),p.inputs.pY.value=t.y=Math.round(a-u+n)}}else if("circularObject"===t.type)switch(selectMode){case"u":s=e=>{let s=Math.round((e.pageY-canvas.height/2)/camScale+camY);t.inputs.radius.value=t.radius=Math.max(n+r-s,0)/2,t.size.y=t.size.x=2*t.radius,t.inputs.y.value=t.pos.y=n+r-t.size.y,t.inputs.x.value=t.pos.x=i+r/2-t.radius};break;case"ur":s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),a=Math.round((e.pageY-canvas.height/2)/camScale+camY);t.inputs.radius.value=t.radius=Math.min(Math.max(n+r-a,0),Math.max(s-i,0))/2,t.size.y=t.size.x=2*t.radius,t.inputs.y.value=t.pos.y=n+r-t.size.y};break;case"r":s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX);t.inputs.radius.value=t.radius=Math.max(s-i,0)/2,t.size.y=t.size.x=2*t.radius,t.inputs.y.value=t.pos.y=n+a/2-t.radius};break;case"dr":s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),a=Math.round((e.pageY-canvas.height/2)/camScale+camY);t.inputs.radius.value=t.radius=Math.min(Math.max(a-n,0),Math.max(s-i,0))/2,t.size.y=t.size.x=2*t.radius};break;case"d":s=e=>{let s=Math.round((e.pageY-canvas.height/2)/camScale+camY);t.inputs.radius.value=t.radius=Math.max(s-n,0)/2,t.size.y=t.size.x=2*t.radius,t.inputs.x.value=t.pos.x=i+r/2-t.radius};break;case"dl":s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),r=Math.round((e.pageY-canvas.height/2)/camScale+camY);t.inputs.radius.value=t.radius=Math.min(Math.max(r-n,0),Math.max(i+a-s,0))/2,t.size.y=t.size.x=2*t.radius,t.inputs.x.value=t.pos.x=i+a-t.size.x};break;case"l":s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX);t.inputs.radius.value=t.radius=Math.max(i+a-s,0)/2,t.size.y=t.size.x=2*t.radius,t.inputs.y.value=t.pos.y=n+a/2-t.radius,t.inputs.x.value=t.pos.x=i+a-t.size.x};break;case"ul":s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),o=Math.round((e.pageY-canvas.height/2)/camScale+camY);t.inputs.radius.value=t.radius=Math.min(Math.max(n+r-o,0),Math.max(i+a-s,0))/2,t.size.y=t.size.x=2*t.radius,t.inputs.x.value=t.pos.x=i+a-t.size.x,t.inputs.y.value=t.pos.y=n+r-t.size.y};break;case"m":s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),a=Math.round((e.pageY-canvas.height/2)/camScale+camY);t.inputs.x.value=t.pos.x=s-o+i,t.inputs.y.value=t.pos.y=a-u+n}}else if("turret"===t.type){if("m"===selectMode){let l=t.region,{x:d,y:c}=l.pos;s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),a=Math.round((e.pageY-canvas.height/2)/camScale+camY);t.inputs.x.value=t.pos.x=s-o+i,t.inputs.y.value=t.pos.y=a-u+n,t.inputs.rX.value=l.pos.x=s-o+d,t.inputs.rY.value=l.pos.y=a-u+c}}}else if("turretRegion"===t.type){if("m"===selectMode){let{x:y,y:x}=t.pos,v=t.turret;s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),a=Math.round((e.pageY-canvas.height/2)/camScale+camY);v.inputs.x.value=t.pos.x=s-o+i,v.inputs.y.value=t.pos.y=a-u+n,v.inputs.rX.value=t.pos.x=s-o+y,v.inputs.rY.value=t.pos.y=a-u+x}}}else switch(selectMode){case"u":s=e=>{let s=Math.round((e.pageY-canvas.height/2)/camScale+camY);n-s+r>0?(t.pos.y=s,t.size.y=n-s+r):(t.pos.y=n+r,t.size.y=0),t.inputs.y.value=t.pos.y,t.inputs.h.value=t.size.y};break;case"ur":s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),a=Math.round((e.pageY-canvas.height/2)/camScale+camY);i-s<0?t.size.x=s-i:t.size.x=0,n-a+r>0?(t.pos.y=a,t.size.y=n-a+r):(t.pos.y=n+r,t.size.y=0),t.inputs.x.value=t.pos.x,t.inputs.y.value=t.pos.y,t.inputs.w.value=t.size.x,t.inputs.h.value=t.size.y};break;case"r":s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX);i-s<0?t.size.x=s-i:t.size.x=0,t.inputs.x.value=t.pos.x,t.inputs.w.value=t.size.x};break;case"dr":s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),a=Math.round((e.pageY-canvas.height/2)/camScale+camY);i-s<0?t.size.x=s-i:t.size.x=0,n-a<0?t.size.y=a-n:t.size.y=0,t.inputs.x.value=t.pos.x,t.inputs.y.value=t.pos.y,t.inputs.w.value=t.size.x,t.inputs.h.value=t.size.y};break;case"d":s=e=>{let s=Math.round((e.pageY-canvas.height/2)/camScale+camY);n-s<0?t.size.y=s-n:t.size.y=0,t.inputs.y.value=t.pos.y,t.inputs.h.value=t.size.y};break;case"dl":s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),r=Math.round((e.pageY-canvas.height/2)/camScale+camY);i-s+a>0?(t.pos.x=s,t.size.x=i-s+a):(t.pos.x=i+a,t.size.x=0),n-r<0?t.size.y=r-n:t.size.y=0,t.inputs.x.value=t.pos.x,t.inputs.y.value=t.pos.y,t.inputs.w.value=t.size.x,t.inputs.h.value=t.size.y};break;case"l":s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX);i-s+a>0?(t.pos.x=s,t.size.x=i-s+a):(t.pos.x=i+a,t.size.x=0),t.inputs.x.value=t.pos.x,t.inputs.w.value=t.size.x};break;case"ul":s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),o=Math.round((e.pageY-canvas.height/2)/camScale+camY);i-s+a>0?(t.pos.x=s,t.size.x=i-s+a):(t.pos.x=i+a,t.size.x=0),n-o+r>0?(t.pos.y=o,t.size.y=n-o+r):(t.pos.y=n+r,t.size.y=0),t.inputs.x.value=t.pos.x,t.inputs.y.value=t.pos.y,t.inputs.w.value=t.size.x,t.inputs.h.value=t.size.y};break;case"m":if("rotatingLava"===t.type){let{x:g,y:h}=t.point;s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),a=Math.round((e.pageY-canvas.height/2)/camScale+camY);t.inputs.x.value=t.pos.x=s-o+i,t.inputs.y.value=t.pos.y=a-u+n,t.inputs.pX.value=t.point.x=g+s-o,t.inputs.pY.value=t.point.y=h+a-u};break}s=e=>{let s=Math.round((e.pageX-canvas.width/2)/camScale+camX),a=Math.round((e.pageY-canvas.height/2)/camScale+camY);t.pos.x=s-o+i,t.pos.y=a-u+n,t.inputs.x.value=t.pos.x,t.inputs.y.value=t.pos.y}}lockCursor=!0,canvas.addEventListener("mousemove",e=>{mousePos={x:(e.pageX-canvas.width/2)/camScale+camX,y:(e.pageY-canvas.height/2)/camScale+camY}}),document.addEventListener("mousemove",s),document.addEventListener("mouseup",()=>{lockCursor=!1,document.removeEventListener("mousemove",s),mousePos={x:(e.pageX-canvas.width/2)/camScale+camX,y:(e.pageY-canvas.height/2)/camScale+camY}})}else selectedObject&&hide(selectedObject.element),selectedObject=null;if(e.detail>1&&selectedObject&&"teleporter"===selectedObject.type&&selectedObject.targetArea!==currentArea.name){let z=null;if(z=map.areas.find(e=>e.name===selectedObject.targetArea)){hide(currentArea.element),currentArea=z,selectedObject&&hide(selectedObject.element);let m=null;(m=z.objects.teleporter.find(e=>e.id===selectedObject.targetID))?(camX=m.pos.x,camY=m.pos.y,selectedObject=m):(selectedObject=null,camX=z.size[0]/2,camY=z.size[1]/2),timeOnEnter=Date.now(),show(z.element);return}confirm(`Did not find area ${selectedObject.targetArea}, would you like to create it?`)&&(addArea(selectedObject.targetArea),camX=50,camY=50)}}),canvas.addEventListener("mousemove",e=>{if(!lockCursor){for(let t of types){let s=getObjects(t);for(let i=s.length-1;i>=0;i--){let n=s[i],[{x:a,y:r},{x:o,y:u}]=points("rotLavaPoint"===t?{pos:n,size:{x:0,y:0}}:n),p=point(e);if("text"===t){if(pointInCircle(p,{x:a,y:r},5*camScale+selectBuffer)){canvas.style.cursor="grab",selectMode="m";return}continue}if("turret"===t){if(pointInCircle(p,{x:a,y:r},3*camScale+selectBuffer)){canvas.style.cursor="grab",selectMode="m";return}continue}if("rotLavaPoint"===t){if(pointInCircle(p,{x:a,y:r},.5*camScale+selectBuffer)){canvas.style.cursor="grab",selectMode="m";return}continue}let l=pointInRect(p,{x:a-selectBuffer,y:r-selectBuffer},{x:o+selectBuffer,y:u+selectBuffer}),d=pointInRect(p,{x:a-selectBuffer,y:r-selectBuffer},{x:o+selectBuffer,y:r+selectBuffer}),c=pointInRect(p,{x:a-selectBuffer,y:r-selectBuffer},{x:a+selectBuffer,y:u+selectBuffer}),y=pointInRect(p,{x:a-selectBuffer,y:u-selectBuffer},{x:o+selectBuffer,y:u+selectBuffer}),x=pointInRect(p,{x:o-selectBuffer,y:r-selectBuffer},{x:o+selectBuffer,y:u+selectBuffer}),v=pointInRect(p,{x:a,y:r},{x:o,y:u});if(v?(canvas.style.cursor="grab",selectMode="m"):y?c?(canvas.style.cursor="nesw-resize",selectMode="dl"):x?(canvas.style.cursor="nwse-resize",selectMode="dr"):(canvas.style.cursor="ns-resize",selectMode="d"):x?d?(canvas.style.cursor="nesw-resize",selectMode="ur"):y?(canvas.style.cursor="nwse-resize",selectMode="dr"):(canvas.style.cursor="ew-resize",selectMode="r"):d?c?(canvas.style.cursor="nwse-resize",selectMode="ul"):x?(canvas.style.cursor="nesw-resize",selectMode="ur"):(canvas.style.cursor="ns-resize",selectMode="u"):c?d?(canvas.style.cursor="nwse-resize",selectMode="ul"):y?(canvas.style.cursor="nesw-resize",selectMode="dl"):(canvas.style.cursor="ew-resize",selectMode="l"):(canvas.style.cursor="initial",selectMode=null),l)return}}canvas.style.cursor="initial"}}),canvas.addEventListener("contextmenu",e=>{e.target!==contextmenu&&(e.preventDefault(),contextmenu.style.left=e.x+1+"px",contextmenu.style.top=e.y+1+"px",selectedObject?show(contextBtns.objectActions):hide(contextBtns.objectActions),selectedObject&&(contextBtns.deleteObject.innerHTML=`Delete Selected Object<br>(${capitalise(selectedObject.type)})`),1===map.areas.length?hide(contextBtns.deleteArea):show(contextBtns.deleteArea),show(contextmenu))}),document.addEventListener("click",e=>{e.target!==contextmenu&&(e.target.parentNode!==contextmenu||2!==e.button)&&(e.target!==canvas||2!==e.button)&&hide(contextmenu)}),document.addEventListener("keydown",e=>{e.target instanceof HTMLInputElement||e.key.toLowerCase()!==(localStorage.getItem("hitbox")??"o")||(renderSettings.render.hitbox=!renderSettings.render.hitbox)}),resizemenu.addEventListener("mousedown",()=>{resizing=!0}),document.addEventListener("mouseup",()=>{resizing=!1}),document.addEventListener("mousemove",e=>{resizing&&(menu.style.width=Math.max(window.innerWidth-e.pageX-15,200)+"px")}),togglemenu.addEventListener("click",()=>{menu.classList.toggle("hidden")}),togglebottommenu.addEventListener("click",()=>{bottommenu.classList.toggle("hidden")}),downloadBtn.addEventListener("click",()=>{map.settings.name||(map.settings.name=prompt("Map name?")),null!==map.settings.name&&(map.settings.creator||(map.settings.creator=prompt("Map creator's username in skap?")),null!==map.settings.creator&&download(map.settings.name||"map"))}),importInput.addEventListener("input",()=>{importInput.files.length&&importInput.files[0].text().then(e=>loadFile(e)).catch(console.error)}),window.addEventListener("beforeunload",e=>(e.preventDefault(),e.returnValue="Have you saved your map?"));{let e=document.createElement("input");e.value=map.settings.name,e.addEventListener("input",()=>{map.settings.name=e.value});let t=document.createElement("input");t.value=map.settings.creator,t.addEventListener("input",()=>{map.settings.creator=t.value});let s=document.createElement("input");s.value=map.settings.spawnArea,s.addEventListener("change",()=>{map.areas.some(e=>e.name===s.value)?map.settings.spawnArea=s.value:confirm(`Area ${s.value} not found, would you like to create it?`)?addArea(s.value):alert("You'd better make that area then.")});let i=document.createElement("input");i.value=map.settings.spawnPos[0],i.addEventListener("input",()=>{map.settings.spawnPos[0]=Number(i.value)});let n=document.createElement("input");n.value=map.settings.spawnPos[1],n.addEventListener("input",()=>{map.settings.spawnPos[1]=Number(n.value)}),map.element=createFolder("Map Properties",[createProperty("name",e,"text"),createProperty("creator",t,"text"),createProperty("spawnArea",s,"text"),createFolder("Spawn Position",[createProperty("x",i,"number"),createProperty("y",n,"number")])]),map.element.classList.add("closed"),menu.insertBefore(map.element,areamenu),map.inputs={name:e,creator:t,spawnArea:s,spawnX:i,spawnY:n}}obstacleBtn.addEventListener("click",addObstacle),lavaBtn.addEventListener("click",addLava),slimeBtn.addEventListener("click",addSlime),iceBtn.addEventListener("click",addIce),contextBtns.obstacle.addEventListener("click",addObstacle),contextBtns.lava.addEventListener("click",addLava),contextBtns.slime.addEventListener("click",addSlime),contextBtns.ice.addEventListener("click",addIce),contextBtns.block.addEventListener("click",addBlock),contextBtns.teleporter.addEventListener("click",addTeleporter),contextBtns.text.addEventListener("click",addText),contextBtns.spawner.addEventListener("click",addSpawner),contextBtns.gravZone.addEventListener("click",addGravZone),contextBtns.rotLava.addEventListener("click",addRotatingLava),contextBtns.cirObj.addEventListener("click",addCircularObject),contextBtns.door.addEventListener("click",addDoor),contextBtns.switch.addEventListener("click",addSwitch),contextBtns.button.addEventListener("click",addButton),contextBtns.turret.addEventListener("click",addTurret),contextBtns.movObj.addEventListener("click",addMovingObject),contextBtns.area.addEventListener("click",()=>addArea()),contextBtns.resetTime.addEventListener("click",()=>timeOnEnter=Date.now()),contextBtns.deleteObject.addEventListener("click",()=>{if(selectedObject){let e=currentArea.objects[selectedObject.type];e.includes(selectedObject)&&(e.splice(e.indexOf(selectedObject),1),selectedObject.element.remove(),selectedObject=null)}}),contextBtns.deleteArea.addEventListener("click",()=>{if(currentArea&&1!==map.areas.length&&confirm("Are you sure you want to delete this area?")){let e=map.areas;e.includes(currentArea)&&(e.splice(e.indexOf(currentArea),1),currentArea.element.remove(),currentArea.button.remove(),show((currentArea=e[0]).element))}});const copyBtn=document.createElement("button");function points(e){return e.pos&&e.size?[{x:Math.round(canvas.width/2+camScale*(e.pos.x-camX)),y:Math.round(canvas.height/2+camScale*(e.pos.y-camY))},{x:Math.round(canvas.width/2+camScale*(e.pos.x+e.size.x-camX)),y:Math.round(canvas.height/2+camScale*(e.pos.y+e.size.y-camY))}]:[{x:0,y:0},{x:0,y:0}]}function point(e){return{x:e.pageX,y:e.pageY}}function pointInRect(e,t,s){return e.x>t.x&&e.x<s.x&&e.y>t.y&&e.y<s.y}function pointInCircle(e,t,s){return(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)<=s*s}function hide(e){e.classList.add("hidden")}function show(e){e.classList.remove("hidden")}function capitalise(e=""){return(e=String(e)).length<=1?e:e[0].toUpperCase()+e.slice(1)}function pasteClipboard(){if(!clipboard||!currentArea||"rotatingLava"===clipboard.type)return;let e=cloneObject(clipboard);if(!e)return;let t=e.type,s;switch(t){case"obstacle":s=createObstacle(e.pos.x,e.pos.y,e.size.x,e.size.y);break;case"lava":s=createLava(e.pos.x,e.pos.y,e.size.x,e.size.y);break;case"slime":s=createSlime(e.pos.x,e.pos.y,e.size.x,e.size.y);break;case"ice":s=createIce(e.pos.x,e.pos.y,e.size.x,e.size.y);break;case"block":s=createBlock(e.pos.x,e.pos.y,e.size.x,e.size.y,e.color,e.opacity,e.collide,e.layer);break;case"teleporter":s=createTeleporter(e.pos.x,e.pos.y,e.size.x,e.size.y,e.dir,e.id,e.targetArea,e.targetId);break;case"text":s=createText(e.pos.x,e.pos.y,e.text);break;case"spawner":s=createSpawner(e.pos.x,e.pos.y,e.size.x,e.size.y,e.enemyType,e.number,e.speed,e.radius);break;case"gravityZone":s=createGravZone(e.pos.x,e.pos.y,e.size.x,e.size.y,e.dir);break;case"rotatingLava":s=createRotatingLava(e.pos.x,e.pos.y,e.size.x,e.size.y,e.point.x,e.point.y,e.startAngle,e.speed);break;case"circularObject":s=createCircularObject(e.pos.x,e.pos.y,e.radius,e.objectType);break;case"door":s=createDoor(e.pos.x,e.pos.y,e.size.x,e.size.y,e.linkIds);break;case"switch":s=createSwitch(e.pos.x,e.pos.y,e.size.x,e.size.y,e.dir,e.id);break;case"button":s=createButton(e.pos.x,e.pos.y,e.size.x,e.size.y,e.dir,e.id,e.time);break;case"turret":s=createTurret(e.pos.x,e.pos.y,e.region.pos.x,e.region.pos.y,e.region.size.x,e.region.size.y,e.radius,e.speed,e.shootingSpeed,e.overHeat,e.coolDownTime);break;case"movingObject":s=createMovingObject(e.size.x,e.size.y,e.objectType,e.points);break;case"hatReward":s=createHatReward(e.pos.x,e.pos.y,e.reward);break;default:return alert("Paste not implemented for "+t)}currentArea.objects[t].push(s),objectmenu.appendChild(s.element),hide(s.element),selectedObject&&hide(selectedObject.element),show((selectedObject=s).element)}copyBtn.id="copyObject",copyBtn.textContent="Copy Object",contextmenu.appendChild(copyBtn),contextBtns.copyObject=copyBtn,contextBtns.copyObject.addEventListener("click",()=>{selectedObject&&(clipboard=cloneObject(selectedObject),hide(contextmenu))}),contextBtns.copyObject.addEventListener("click",()=>{if(!selectedObject)return;let e=cloneObject(selectedObject);e&&(clipboard=e,hide(contextmenu))}),addArea("Home"),function e(){render(),window.requestAnimationFrame(e)}(),document.addEventListener("keydown",e=>{if(!(e.target instanceof HTMLInputElement)){if(e.key.toLowerCase()===(localStorage.getItem("hitbox")??"o")){renderSettings.render.hitbox=!renderSettings.render.hitbox;return}if(e.ctrlKey&&"c"===e.key.toLowerCase()&&selectedObject){let t=cloneObject(selectedObject);if(!t)return;clipboard=t,e.preventDefault()}e.ctrlKey&&"v"===e.key.toLowerCase()&&clipboard&&currentArea&&(pasteClipboard(),e.preventDefault())}});